import React, { useState, useEffect } from 'react';
import AdminLayout from '../../components/AdminLayout';
import axios from 'axios';

const AdminContacts = () => {
  const [contacts, setContacts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedContact, setSelectedContact] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [reply, setReply] = useState('');

  useEffect(() => {
    fetchContacts();
  }, []);

  const fetchContacts = async () => {
    try {
      const response = await axios.get('/api/contacts/admin');
      setContacts(response.data);
    } catch (error) {
      console.error('Error fetching contacts:', error);
    } finally {
      setLoading(false);
    }
  };

  const updateContactStatus = async (contactId, status) => {
    try {
      await axios.put(`/api/contacts/${contactId}/status`, { status });
      alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
      fetchContacts();
    } catch (error) {
      console.error('Error updating contact status:', error);
      alert(error.response?.data?.message || 'C√≥ l·ªói x·∫£y ra!');
    }
  };

  const handleReply = async () => {
    if (!reply.trim()) {
      alert('Vui l√≤ng nh·∫≠p n·ªôi dung tr·∫£ l·ªùi!');
      return;
    }

    try {
      await axios.put(`/api/contacts/${selectedContact.id}/reply`, { 
        admin_reply: reply,
        status: 'resolved'
      });
      alert('Tr·∫£ l·ªùi th√†nh c√¥ng!');
      setShowModal(false);
      setReply('');
      setSelectedContact(null);
      fetchContacts();
    } catch (error) {
      console.error('Error sending reply:', error);
      alert(error.response?.data?.message || 'C√≥ l·ªói x·∫£y ra!');
    }
  };

  const getStatusBadgeClass = (status) => {
    switch (status) {
      case 'new': return 'bg-primary';
      case 'processing': return 'bg-warning';
      case 'resolved': return 'bg-success';
      default: return 'bg-secondary';
    }
  };

  const getStatusText = (status) => {
    switch (status) {
      case 'new': return 'M·ªõi';
      case 'processing': return 'ƒêang x·ª≠ l√Ω';
      case 'resolved': return 'ƒê√£ gi·∫£i quy·∫øt';
      default: return status;
    }
  };

  return (
    <AdminLayout>
      <h2 className="mb-4">üìû Qu·∫£n l√Ω li√™n h·ªá</h2>

      {loading ? (
        <div className="text-center py-5">
          <div className="spinner-border text-primary" role="status">
            <span className="visually-hidden">Loading...</span>
          </div>
        </div>
      ) : (
        <div className="admin-table">
          <table className="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>H·ªç t√™n</th>
                <th>Email</th>
                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                <th>Ch·ªß ƒë·ªÅ</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng√†y g·ª≠i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              {contacts.map(contact => (
                <tr key={contact.id}>
                  <td>{contact.id}</td>
                  <td>{contact.name}</td>
                  <td>{contact.email}</td>
                  <td>{contact.phone || 'Ch∆∞a c√≥'}</td>
                  <td>
                    <span className="text-truncate d-inline-block" style={{maxWidth: '200px'}}>
                      {contact.subject}
                    </span>
                  </td>
                  <td>
                    <span className={`badge ${getStatusBadgeClass(contact.status)}`}>
                      {getStatusText(contact.status)}
                    </span>
                  </td>
                  <td>
                    {new Date(contact.created_at).toLocaleDateString('vi-VN')}
                  </td>
                  <td>
                    <div className="dropdown">
                      <button 
                        className="btn btn-sm btn-outline-primary dropdown-toggle" 
                        type="button" 
                        data-bs-toggle="dropdown"
                      >
                        Thao t√°c
                      </button>
                      <ul className="dropdown-menu">
                        <li>
                          <button 
                            className="dropdown-item"
                            onClick={() => {
                              setSelectedContact(contact);
                              setShowModal(true);
                            }}
                          >
                            Xem chi ti·∫øt & Tr·∫£ l·ªùi
                          </button>
                        </li>
                        <li><hr className="dropdown-divider" /></li>
                        <li>
                          <button 
                            className="dropdown-item"
                            onClick={() => updateContactStatus(contact.id, 'processing')}
                            disabled={contact.status === 'resolved'}
                          >
                            ƒê√°nh d·∫•u ƒëang x·ª≠ l√Ω
                          </button>
                        </li>
                        <li>
                          <button 
                            className="dropdown-item"
                            onClick={() => updateContactStatus(contact.id, 'resolved')}
                            disabled={contact.status === 'resolved'}
                          >
                            ƒê√°nh d·∫•u ƒë√£ gi·∫£i quy·∫øt
                          </button>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Modal */}
      {showModal && selectedContact && (
        <div className="modal show d-block admin-modal" tabIndex="-1">
          <div className="modal-dialog modal-lg">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">Chi ti·∫øt li√™n h·ªá</h5>
                <button 
                  type="button" 
                  className="btn-close" 
                  onClick={() => {
                    setShowModal(false);
                    setSelectedContact(null);
                    setReply('');
                  }}
                ></button>
              </div>
              <div className="modal-body">
                <div className="row mb-3">
                  <div className="col-md-6">
                    <strong>H·ªç t√™n:</strong> {selectedContact.name}
                  </div>
                  <div className="col-md-6">
                    <strong>Email:</strong> {selectedContact.email}
                  </div>
                </div>
                
                <div className="row mb-3">
                  <div className="col-md-6">
                    <strong>S·ªë ƒëi·ªán tho·∫°i:</strong> {selectedContact.phone || 'Ch∆∞a c√≥'}
                  </div>
                  <div className="col-md-6">
                    <strong>Tr·∫°ng th√°i:</strong>{' '}
                    <span className={`badge ${getStatusBadgeClass(selectedContact.status)}`}>
                      {getStatusText(selectedContact.status)}
                    </span>
                  </div>
                </div>

                <div className="mb-3">
                  <strong>Ch·ªß ƒë·ªÅ:</strong>
                  <div className="mt-1">{selectedContact.subject}</div>
                </div>

                <div className="mb-3">
                  <strong>N·ªôi dung:</strong>
                  <div className="mt-1 p-3 bg-light rounded">
                    {selectedContact.message}
                  </div>
                </div>

                {selectedContact.admin_reply && (
                  <div className="mb-3">
                    <strong>Ph·∫£n h·ªìi c·ªßa admin:</strong>
                    <div className="mt-1 p-3 bg-primary text-white rounded">
                      {selectedContact.admin_reply}
                    </div>
                  </div>
                )}

                {selectedContact.status !== 'resolved' && (
                  <div className="mb-3">
                    <label className="form-label"><strong>Tr·∫£ l·ªùi:</strong></label>
                    <textarea
                      className="form-control"
                      rows="4"
                      value={reply}
                      onChange={(e) => setReply(e.target.value)}
                      placeholder="Nh·∫≠p ph·∫£n h·ªìi cho kh√°ch h√†ng..."
                    />
                  </div>
                )}
              </div>
              <div className="modal-footer">
                <button 
                  type="button" 
                  className="btn btn-secondary" 
                  onClick={() => {
                    setShowModal(false);
                    setSelectedContact(null);
                    setReply('');
                  }}
                >
                  ƒê√≥ng
                </button>
                {selectedContact.status !== 'resolved' && (
                  <button 
                    type="button"
                    className="btn btn-primary"
                    onClick={handleReply}
                  >
                    G·ª≠i ph·∫£n h·ªìi
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
      {showModal && <div className="modal-backdrop show"></div>}
    </AdminLayout>
  );
};

export default AdminContacts;
